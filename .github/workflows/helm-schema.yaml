---
name: Helm Schema

permissions: {}

on:
  push:
    branches:
      - "**"
    paths:
      - "charts/**"
  pull_request:
    branches-ignore:
      - "release-**/bundle-update"
    paths:
      - "charts/**"

jobs:
  schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
          cache: false

      - name: Generate Helm values schema
        run: make helm-schema

      - name: Verify schema is up to date
        run: |
          if ! git diff --exit-code -- charts/k6-operator/values.schema.json; then
            echo "::error::values.schema.json is not up to date. Run 'make helm-schema' and commit the result."
            echo "---- diff ----"
            git diff -- charts/k6-operator/values.schema.json
            exit 1
          fi